<style type="text/css">

	ul#pages, ul#optionList, ul#subQuestionList {
		list-style-type: none;
		list-style-position: outside;

		margin: 0;
		padding: 0;
	}

	ul.questionarePage, ul.questionareSection {
		list-style-type: none;
		list-style-position: outside;
		margin: 5px 0px 5px 0px;
		padding: 0px;
	}
	
	.logicReminder {
	   font-size: 12px;
	   color: grey;
	   font-style: italic;
	   padding-left: 30px;
	   margin:15px 10px 10px 10px;
	}
	
	.logicListItem {
	   background: rgb(223, 241, 255);
	   width: 400px;
	   margin: 5px;
	   padding: 5px;
	}
	
	.optionListItem {
		margin: 2px 0 2px 0;
		padding: 2px 5px 2px 2px;
		margin: 2px 0 2px 0;
		width: 614px;
		border: #BEBEBE 1px solid;
		background: #ECECEC;
		color: #7E7E7E;
		float:left;
	}

	.optionRemoveButton, .logicElementRemoveButton {
		float:right;
		width: 16px;
		height: 16px;
		cursor: pointer;
		background: url(gfx/icons/cancel.png);
		margin-top: 5px;
	}

	.optionMovableButton {
		float: right;
		width: 16px;
		height: 16px;
		padding: 2 px;
		margin: 5px 10px;
		cursor: pointer;
		background: url(gfx/icons/move.png);
	}

	#editTextPartArea {
		font-family: monospace;
		width: 100%;
		height: 200px;
	}

	.invisibleQuestion {
		background: #CCCCFF;
	}
	
	.tinyEditor_small + span > table.mceLayout {
	   width: 508px;
	} 



</style>

<div class="innerContainer">
{BUTTONSTOP}
<ul id="pages">
	{QUESTIONNARE}
</ul>
{BUTTONSBOTTOM}
</div>

<!-- Dialogues -->
<div id="createQuestionDialog" title="Add Question" style="display:none;">
	{EDITQUESTIONTABLE}
</div>
<div id="editSectionTitleDialog" title="Edit Section Title" style="display:none;">
	<form id="editSectionTitleForm" action="" onsubmit="return false;">
	<table cellpadding="0" cellspacing="0" class="gui-dialog-table">
		<tr>
			<td style="width: 150px;">
				Section title:
			</td>
			<td>
			 	<input type="text" name="sectionTitle" id="sectionTitle" value="" class="gui-dialog-element" />
			</td>
		</tr>
		</table>
	</form>
</div>

<div id="createQuestionLogicDialog" title="Question Logic" style="display:none;">
	<form id="createQuestionLogicForm" action="">
	<table cellpadding="0" cellspacing="0" class="gui-dialog-table">
		<tr><td><div class="gui-dialog-divider"></div></td></tr>
		<!--  <tr>
			<td>
			Active Logic Description: <br />

			</td>
		</tr>
		<tr>
				<td><input id="activeLogic" type="text" name="activeLogic"  style="width: 500px"/> <br /></td>
		</tr>-->
		<tr>
			<td>
				Logic Conditions: <span id="topAddCondition" style="margin-left: 15px;" class="link underlinedLink bAddCondition"> Add condition</span>
			</td>
		</tr>
		<tr>
		  <td style="height: 20px;">
		      <div class="gui-dialog-divider" style="margin: 10px 0px 0px 0px;"></div>
		  </td>
		</tr>
		<tr>
			<td style="vertical-align:middle;" id="logicConditions">
			</td>
		</tr>
		<tr>
			<td>
				<span style="display:none;" id="bottomAddCondition" class="link underlinedLink bAddCondition">Add condition</span>
			</td>
		</tr>
	</table>
	</form>
</div>

<div id="forbiddenLogicDialog" title="Logic Tutorial" style="display:none">
	<table cellpadding="0" cellspacing="0" class="gui-dialog-table" >
		<tr>
			<td>{help:dlg.chainLogic}</td>
		</tr>
		<tr>
			<td>Error Message:</td>
		</tr>
		<tr>
			<td class="logicErrMsg"></td>
		</tr>
	</table>
</div>


<script type="text/javascript">
/* <![CDATA[*/
	var copyQuestionID = -1;
	var moveQuestionID = -1;

	var copySectionID = -1;
	var moveSectionID = -1;

	var copyPageID = -1;
	var movePageID = -1;

	var changedAnswerScale = false;
	var changedQuestionText = false;

	$(function() {
		
		changedAnswerScale = false;
		changedQuestionText = false;
	    
		$("#addAns").button();
	    $("#addQuest").button();
	    $("#addSect").button();
	    $("#addPage").button();
	    
		$(".button").button();
		$("input:button").button();
		$('.additionalOptions').hide();

		$('#questionType').live("change", (function() {
			checkSectionVisibility();
		}));

		$('#questionType').live("keyup", (function() {
			checkSectionVisibility();
		}));

		$('#optionText').live("keydown", (function(event) {
			if (event.keyCode == '13') {
				event.preventDefault();
				$('#bAddOption').click();
			}
		}));

		$('#bAddOption').live("click", (function() {
			addOption();
		}));

		$('.optionRemoveButton').live('click', function() {
			var listItem = $(this).parent();
			listItem.fadeOut(function() { $(this).remove();});
		});

		/*
		 $('.optionMovableButton').live('click', function() {
		 });
		*/

		$('.logicElementRemoveButton').live('click', function() {
			var item = $(this).parent();
			conditionCounter--;
			if (conditionCounter > 0){
				$("#bottomAddCondition").show();
			} else {
				$("#bottomAddCondition").hide();
			}
			item.fadeOut(function() { $(this).remove();});
		});

		$('#subQuestionText').live("keydown", (function(event) {
			if (event.keyCode == '13') {
				event.preventDefault();
				$('#bAddSubQuestion').click();
			}
		}));

		$('#bAddSubQuestion').live("click", (function() {
			addSubQuestion();
		}));


		$(".addPageButton").click(function(){
			ajax({
				url: ("{$BASEURL$}/survey/create?part=page&surveyID={SURVEYID}"),
				type: "GET",
				success:
					function (result) {
						if (result != "") {
							location.href='{NEXTPAGELINK}';
						}
					}
			});
		});

		$(".addSectionButton").live("click", (function(){
			var pageID = $(this).attr("id").substring(3);
			ajax({
				url: ("{$BASEURL$}/survey/create?part=section&pageID=" + pageID),
				type: "GET",
				success:
					function (result) {
						if (result != "") {
							location.href= '#section' + result;
							location.reload();
						}
					}
			});
		}));

		$(".addQuestionButton").live("click", (function(){
			openCreateQuestionDialog($(this).attr("id").substring(3));
		}));

		$(".addLogicButton").live("click", (function(){
			var indexOfFirstSpace = $(this).attr("class").indexOf(" ");
			openAddLogicDialog($(this).attr("id").substring(3), $(this).attr("class").substring(0, indexOfFirstSpace));
		}));

		$("#questionText").bind('input', function() {
			changedQuestionText = true;
		} );

		$("#alias").bind('input', function() {
			changedQuestionText = true;
		} );

		$("*[class*=gui-dialog-field-width]:visible").bind('input', function(){
			changedAnswerScale = true;
		});

		$("#bAddOption").click(function() {
			changedAnswerScale = true;
		});

		$(".editQuestionButton").live("click", (function(){
			var questionID = $(this).attr("id").substring(3);
			$("#createQuestionDialog").dialog({
				title: "Edit Question",
				autoOpen: false,
				height: 600,
				width: 800,
				modal: true,
				maximize: true,
				open: function(event, ui) {
					ajax({
						url: ("{$BASEURL$}/survey/retrieve?part=questionEditTable&questionID=" + questionID + "&surveyID={SURVEYID}"),
						type: "GET",
						success:
							function (result) {
								if (result != "") {
									$('#createQuestionDialog').html(result);
									checkSectionVisibility();
									makeOptionsSortable();
									initializeTinyMce();
								}
							}
					});
					augmentDialogWithMaximizeButton($(this), 'createQuestionDialog');
				},
				buttons: {
					'Save Question': function() {
						var deleteActiveLogicAndEditQuestion = true;
						if($('#bal'+questionID).length > 0){
							if ($('#bal'+questionID).attr("class").indexOf('ARROW_BRANCH_GRAY') === -1){
								/* there is some logic active, confirm to delete logic? */
								if (confirm('There is an active logic defined within this question. It will be removed after you edit this Question. Still save edited changes and remove current logic?')){
									deleteActiveLogicAndEditQuestion = true;
								} else {
									deleteActiveLogicAndEditQuestion = false;
								}
							}
						}
						if (deleteActiveLogicAndEditQuestion){
							if ($('#questionType').val().substring(0,8) == 'textpart' || ($('#questionType').val().substring(0,8) != 'textpart' && $('#questionText').val() != '')) {
								if ($('#questionType').val().substring(0,8) == 'textpart'){
									$('#editTextPartArea').val(tinyMCE.get('editTextPartArea').getContent());
								}
								$('#addInfo').val(tinyMCE.get('addInfo').getContent());

								ajax({
									url: ("{$BASEURL$}/survey/update?part=question&questionID=" + questionID),
									type: "POST",
									data: $("#createQuestionForm").serialize(),
									success:
										function (result) {
											$('#createQuestionDialog').dialog('close');
											location.reload();
										}
								});
							} else {
								alert("Enter a question text!");
								$('#questionText').focus();
							}
						}
					},
					'Cancel': function() {
						$(this).dialog('close');
						$(this).dialog('destroy');
					}
				},
				Cancel: function() {
					$(this).dialog('close');
					$(this).dialog('destroy');
				}
			});

			$('#createQuestionDialog').dialog('open');
		}));

	});



	
	function checkSectionVisibility() {
		var value = $('#questionType').val();
		switch(value) {
		case 'multiplematrix':
		case 'radiomatrix':
			$('.editOptionSection').show();
			$('.editSubQuestionSection').show();
			$('.editTextPartSection').hide();
			$('.dialogQuestionText').show();
			$('.editAlignmentSection').hide();
			$('.editSingleLineHint').hide();
			$('.editAverageNumHint').hide();
			 break;
		case 'multiple':
		case 'radio':
			$('.editOptionSection').show();
			$('.editSubQuestionSection').hide();
			$('.editTextPartSection').hide();
			$('.dialogQuestionText').show();
			$('.editAlignmentSection').show();
			$('.editSingleLineHint').hide();
			$('.editAverageNumHint').hide();
			break;
		case 'combo':
			$('.editOptionSection').show();
			$('.editSubQuestionSection').hide();
			$('.editTextPartSection').hide();
			$('.dialogQuestionText').show();
			$('.editAlignmentSection').hide();
			$('.editSingleLineHint').hide();
			$('.editAverageNumHint').hide();
			break;
		case 'textpart_phone':
		case 'textpart':
			$('.editTextPartSection').show();
			$('.editOptionSection').hide();
			$('.editSubQuestionSection').hide();
			$('.dialogQuestionText').hide();
			$('.editAlignmentSection').hide();
			$('.editSingleLineHint').hide();
			$('.editAverageNumHint').hide();
			break;
		case 'singleline':
			$('.editTextPartSection').hide();
			$('.editOptionSection').hide();
			$('.editSubQuestionSection').hide();
			$('.dialogQuestionText').show();
			$('.editAlignmentSection').hide();
			$('.editSingleLineHint').show();
			$('.editAverageNumHint').hide();
			break;
		case 'averageNumber':
			$('.editTextPartSection').hide();
			$('.editOptionSection').hide();
			$('.editSubQuestionSection').hide();
			$('.dialogQuestionText').show();
			$('.editAlignmentSection').hide();
			$('.editSingleLineHint').hide();
			$('.editAverageNumHint').show();
			break;
		default:
			$('.additionalOptions').hide();
			$('.dialogQuestionText').show();
		}
	}

	function addOption() {
		if ($('#optionText').val() != '') {
			$('#optionList').append('<li class="optionListItem"><span class="optionRemoveButton" style="vertical-align: middle;"></span><span class="optionMovableButton"></span><input style="width: 550px;" class="gui-dialog-field-width" type="text" name="options[]" value="' + $("#optionText").val() + '" /></li>');
			$('#optionText').val('');
			$('#optionText').focus();
		}
	}

	function addSubQuestion() {
		if ($('#subQuestionText').val() != '') {
			$('#subQuestionList').append('<li class="optionListItem"><span class="optionRemoveButton" style="vertical-align: middle;"></span><span class="optionMovableButton"></span><input style="width: 550px;" class="gui-dialog-field-width" type="text" name="subQuestions[]" value="' + $('#subQuestionText').val() + '" /></li>');
			$('#subQuestionText').val('');
			$('#subQuestionText').focus();
		}
	}

	function initializeTinyMce(){
		tinyMCE.init({
	        mode : "specific_textareas",
	        theme : "advanced",
			width : "100%",
			height: "300px",
			plugins: "paste",
			paste_auto_cleanup_on_paste : true,
			paste_remove_styles: true,
			content_css: "{$BASEURL$}/css_ext/scc.css",
			theme_advanced_font_sizes: "10px,12px,13px,14px,16px,18px,20px",
			font_size_style_values : "10px,12px,13px,14px,16px,18px,20px",

			theme_advanced_resizing_max_height : "350",

	        theme_advanced_buttons1 : "undo,redo,|,bold,italic,underline,|,hr,|,justifyleft,justifycenter,justifyright,|,fontsizeselect,forecolor,|,removeformat,cleanup",
	        theme_advanced_buttons2: "",
	        theme_advanced_buttons3: "",
	        theme_advanced_toolbar_location : "top",
	        theme_advanced_toolbar_align : "left",
	        theme_advanced_resizing : true,
	        theme_advanced_statusbar_location : "none",
	        formats : {removeformat: [ { selector: 'b,strong,em,i,span,ins,h1,h2,h3,h4,h5,h6,u', remove:'all', split : true, expand : false, block_expand : true, deep : true}]},
	    	editor_selector: "tinyEditor"
		});
		
		tinyMCE.init({
		    mode : "specific_textareas",
		    theme : "advanced",
		    width : "508px",
		    height: "50px",
		    content_css: "{$BASEURL$}/css_ext/scc.css",

		    theme_advanced_resizing_min_height : 50,


		    theme_advanced_buttons1 : "bold,italic,underline",
		    theme_advanced_buttons2: "",
		    theme_advanced_buttons3: "",
		    theme_advanced_toolbar_location : "top",
		    theme_advanced_toolbar_align : "left",
		    theme_advanced_resizing : true,
		    theme_advanced_statusbar_location : "none",
		    editor_selector: "tinyEditor_small",
		    setup : function(ed) {
		        ed.onInit.add(function() {
		            var e = tinymce.DOM.get(ed.id + '_tbl'), ifr = tinymce.DOM.get(ed.id + '_ifr'), w = ed.getWin(), dh;
		            var h = 36; /*new height of edit area */
		            dh = e.clientHeight - ifr.clientHeight; /*toolbar height calculation*/
		            ed.theme.resizeTo(w.clientWidth, h + dh);
		        });
		    }
	    });
	}

	function openCreateQuestionDialog(sectionID) {
		
		$("#createQuestionDialog").dialog({
			autoOpen: false,
			height: 600,
			width: 800,
			modal: true,
			maximize: true,
			position: 'center',
			open: function(event, ui) {
				ajax({
					url: ("{$BASEURL$}/survey/retrieve?part=questionEditTable&surveyID={SURVEYID}"),
					type: "GET",
					success:
						function (result) {
							if (result != "") {
								$('#createQuestionDialog').html(result);
								checkSectionVisibility();
								makeOptionsSortable();
								initializeTinyMce();
							}
						}
				});
				augmentDialogWithMaximizeButton($(this), 'createQuestionDialog');
			},
			buttons: {
				'Create Question': function() {
					if ($('#questionType').val().substring(0,8) == 'textpart' || ($('#questionType').val().substring(0,8) != 'textpart' && $('#questionText').val() != '')) {
						$('#editTextPartArea').val(tinyMCE.get('editTextPartArea').getContent());
						$('#addInfo').val(tinyMCE.get('addInfo').getContent());
						
						ajax({
							url: ("{$BASEURL$}/survey/create?part=question&sectionID=" + sectionID),
							type: "POST",
							data: $("#createQuestionForm").serialize().replace('editTextPartArea=','') + '&editTextPartArea=' + encodeURIComponent($('#editTextPartArea').val()).replace('addInfo=','') + '&addInfo=' + encodeURIComponent($('#addInfo').val()),
							success:
								function (result) {
									$('#createQuestionDialog').dialog('close');
									location.href= '#section' + sectionID;
									location.reload();
								},
							error:
								function (xhr, status) {
									$('#createQuestionDialog').html("Error");
								}
						});
					} else {
						alert("Enter a question text!");
						$('#questionText').focus();
					}
				},
				'Cancel': function() {
					$(this).dialog('close');
					$(this).dialog('destroy');
				}
			},
			Cancel: function() {
				$(this).dialog('close');
				$(this).dialog('destroy');
			}
		});
		$('#createQuestionDialog').dialog('open');
	}


	function buildLogicCondition(){
		ajax({
			url: ("{$BASEURL$}/survey/create?createLogic=1"),
			type: "POST",
			success:
				function (result) {
					$('#logicConditions').append(result);
					location.href= '#section' + sectionID;
					location.reload();
				},
			error:
				function (xhr, status) {
					$('#createQuestionDialog').html("Error");
				}
		});
	}



	function addQuestionId(questionId, currentConditionCount){
		var questId = $('#logicConditions').find('.qSelector'+'_' + currentConditionCount+' :selected').text();
		if (questId != '') {
			$('#logicConditions').find('#idReminder_' + currentConditionCount).text("");
			$('#logicConditions').find('.targetIds' + questionId + "_" + currentConditionCount).append('<li class="logicListItem"><input type="hidden" name="questions['+currentConditionCount+']" value="' + questId + '" />'+ questId + '<a title="Remove" class="gui-icon-BIN_EMPTY" style="float:right; padding-right:10px;" onclick="removeParentQuestId(this);"></a></li>');
			$('#logicConditions').find('.qSelector'+'_' + currentConditionCount+' :selected').remove();
		}
	}

	function addSectionId(questionId, currentConditionCount){
	    var sectionId = $('#logicConditions').find('.sSelector'+'_' + currentConditionCount+' :selected').text();
        if (sectionId != '') {
        	$('#logicConditions').find('#idReminder_' + currentConditionCount).text("");
			$('#logicConditions').find('.targetIds' + questionId + "_" + currentConditionCount).append('<li class="logicListItem"><input type="hidden" name="sections['+currentConditionCount+']" value="' + sectionId + '" />'+ sectionId +'<a title="Remove" class="gui-icon-BIN_EMPTY" style="float:right; padding-right:10px;" onclick="removeParentSectId(this);"></a></li>');
			$('#logicConditions').find('.sSelector'+'_' + currentConditionCount+' :selected').remove();
        }
	}

	function addPageId(questionId, currentConditionCount){
		var pageId = $('#logicConditions').find('.pSelector'+'_' + currentConditionCount+' :selected').text();
        if (pageId != '') {
        	$('#logicConditions').find('#idReminder_' + currentConditionCount).text("");
			$('#logicConditions').find('.targetIds' + questionId + "_" + currentConditionCount).append('<li class="logicListItem"><input type="hidden" name="pages['+currentConditionCount+']" value="' + pageId + '" />'+ pageId + '<a title="Remove" class="gui-icon-BIN_EMPTY" style="float:right; padding-right:10px;" onclick="removeParentPageId(this);"></a></li>');
			$('#logicConditions').find('.pSelector'+'_' + currentConditionCount+' :selected').remove();
        }
    }

	var conditionCounter = 0;

	function preLoadLogicCondition(operator, answers, typeOfPart, idOfPart, questionId){
		conditionCounter++;
		var answersArray = answers.split(",");
		var arrLength = answersArray.length;
		var conditionsContainer = $('#logicConditions');
		conditionsContainer.append($('#logicSource'+questionId).html());

		/* preLoad-Mode is only View and Delete Mode*/
		conditionsContainer.find('.answerList' + questionId).attr("class", "answerList"+questionId+"_"+conditionCounter);
		conditionsContainer.find('.targetIds' + questionId).attr("class", "targetIds"+questionId+"_"+conditionCounter);
		conditionsContainer.find('.value' + questionId).remove();
		conditionsContainer.find('.partType' + questionId).replaceWith(' ' + typeOfPart + ' ');
		conditionsContainer.find('.qSelector').remove();
		conditionsContainer.find('.sSelector').remove();
		conditionsContainer.find('.pSelector').remove();

		conditionsContainer.find('.addAnswer').remove();
		conditionsContainer.find('#answerReminder').remove();
		conditionsContainer.find('#idReminder').remove();


		for (var j = 0; j < arrLength; j++){
			var item = answersArray[j];
			conditionsContainer.find('.answerList' +questionId + '_' + conditionCounter).append('<li><input type="hidden" name="answers['+conditionCounter+']" value="' + item + '" />'+ item + '</li>');
		}
		conditionsContainer.find('.targetIds' + questionId + '_' + conditionCounter).append('<li><input type="hidden" name="'+typeOfPart+'s['+conditionCounter+']" value="' + idOfPart + '" />'+ idOfPart + '</li>');
		$('#activeLogic').val($('#logic_'+ questionId).val());
		conditionsContainer.find('.logicElement' + questionId).css('background-color', 'Lavender');
		conditionsContainer.find('.logicElement' + questionId).css('border-bottom', '1px solid #CACACA');
		conditionsContainer.find('.logicElement' + questionId).css('padding', '10px 10px 10px 10px');
	}

	function addLogicCondition(operator, answers, typeOfPart, idOfPart, questionId) {
		conditionCounter++;
		var currentPosition = conditionCounter;
		var conditionsContainer = $('#logicConditions');
		conditionsContainer.append($('#logicSource'+questionId).html());
		conditionsContainer.find('.logicElement' + questionId).css('border-bottom', '1px solid #CACACA');
		conditionsContainer.find('.logicElement' + questionId).css('padding', '0px 10px 5px 10px');
		conditionsContainer.find('.logicElement' + questionId).attr("class", "logicElement" + questionId + "_"  + currentPosition);
		conditionsContainer.find('.answerList' + questionId).attr("class", "answerList"+questionId+"_"+currentPosition);
		conditionsContainer.find('.targetIds' + questionId).attr("class", "targetIds"+questionId+"_"+currentPosition);
		conditionsContainer.find('.value' + questionId).attr("class", "value"+questionId+"_"+currentPosition);
		conditionsContainer.find('.partType' + questionId).attr("class", "partType_" + currentPosition);
		conditionsContainer.find('.partType_' + currentPosition).change(function(){partTypeChange(currentPosition)});
		conditionsContainer.find('.qSelector').attr("class", "qSelector_"+currentPosition);
		conditionsContainer.find('.sSelector').attr("class", "sSelector_"+currentPosition);
		conditionsContainer.find('.pSelector').attr("class", "pSelector_"+currentPosition);
		conditionsContainer.find('.addAnswer').attr("class", "addAnswer_"+currentPosition);
		conditionsContainer.find('.addAnswer_'+currentPosition).click(function(){addAnswer(questionId,currentPosition);return false;});
		conditionsContainer.find('.addQuestionId').attr("class", "addQuestionId_"+currentPosition);
		conditionsContainer.find('.addQuestionId_'+currentPosition).click(function(){addQuestionId(questionId,currentPosition);return false;});
		conditionsContainer.find('.addSectionId').attr("class", "addSectionId_"+currentPosition);
		conditionsContainer.find('.addSectionId_'+currentPosition).click(function(){addSectionId(questionId,currentPosition);return false;});
		conditionsContainer.find('.addPageId').attr("class", "addPageId_"+currentPosition);
		conditionsContainer.find('.addPageId_'+currentPosition).click(function(){addPageId(questionId,currentPosition);return false;});
		conditionsContainer.find('#answerReminder').attr("id", "answerReminder_"+currentPosition);
		conditionsContainer.find('#idReminder').attr("id", "idReminder_"+currentPosition);
		designLogicButtons('.addAnswer', currentPosition);
		designLogicButtons('.addQuestionId', currentPosition);
		designLogicButtons('.addSectionId', currentPosition);
		designLogicButtons('.addPageId', currentPosition);
		if (currentPosition > 0){
			  $("#bottomAddCondition").show();			
		} else {
			$("#bottomAddCondition").hide(); 
		}
	}
	
	function designLogicButtons(buttonClass, currentPosition){
		var conditionsContainer = $('#logicConditions');
		conditionsContainer.find(buttonClass+'_'+currentPosition).button();
		conditionsContainer.find(buttonClass+'_'+currentPosition).css('height','30px');
		conditionsContainer.find(buttonClass+'_'+currentPosition).css('width','170px');
		conditionsContainer.find(buttonClass+'_'+currentPosition).css('margin','10px 10px 10px 20px');
		conditionsContainer.find(buttonClass+'_'+currentPosition).css('font-size','13px');
		conditionsContainer.find(buttonClass+'_'+currentPosition).removeClass('ui-button');
	}

	function addAnswer(questionId, currentConditionCount){
		var answerId = $('#logicConditions').find('.value' + questionId + '_' + currentConditionCount + ' :selected').val();
		if (typeof answerId != 'undefined') {
			var text = $('#logicConditions').find('.value' + questionId + '_' + currentConditionCount + ' :selected').text();
			$('#logicConditions').find('#answerReminder_' + currentConditionCount).text("");
			$('#logicConditions').find('.answerList' + questionId + "_" + currentConditionCount).append('<li class="logicListItem"><input type="hidden" name="answers['+currentConditionCount+']" value="' + answerId + '" /><input type="hidden" name="answerTexts['+currentConditionCount+']" value="' +text+'" />'+ text + '<a title="Remove" style="float:right;padding-right:10px;" class="gui-icon-BIN_EMPTY" onclick="removeParent(this,'+questionId+','+currentConditionCount+');"></a></li>');
			$('#logicConditions').find('.value' + questionId + '_' + currentConditionCount + ' :selected').remove();
		}
	}

	function removeParent(obj, questionId, currentConditionCount){
		var orgText = $(obj).parent().text();
		var parentText = orgText;
		$('.value' + questionId + '_' + currentConditionCount).append($('<option></option>').val(parentText).html(parentText));
		$(obj).parent().remove();
	}

	function removeParentQuestId(obj){
		var orgText = $(obj).parent().text();
		var parentText = orgText;
		$('.questSel').append($('<option></option>').val(parentText).html(parentText));
		$(obj).parent().remove();
	}

	function removeParentSectId(obj){
		var orgText = $(obj).parent().text();
		var parentText = orgText;
		$('.sectSel').append($('<option></option>').val(parentText).html(parentText));
		$(obj).parent().remove();
	}

	function removeParentPageId(obj){
		var orgText = $(obj).parent().text();
		var parentText = orgText;
		$('.pageSel').append($('<option></option>').val(parentText).html(parentText));
		$(obj).parent().remove();
	}

	function partTypeChange(conditionCount){
			if($('#logicConditions').find('.partType_'+ conditionCount +' :selected').val() == 'question'){
				$('#logicConditions').find('.qSelector'+'_' + conditionCount+'').show();
				$('#logicConditions').find('.sSelector'+'_' + conditionCount+'').hide();
				$('#logicConditions').find('.pSelector'+'_' + conditionCount+'').hide();
			} else if ($('#logicConditions').find('.partType_'+ conditionCount +' :selected').val() == 'section'){
				$('#logicConditions').find('.qSelector'+'_' + conditionCount+'').hide();
				$('#logicConditions').find('.sSelector'+'_' + conditionCount+'').show();
				$('#logicConditions').find('.pSelector'+'_' + conditionCount+'').hide();
			} else if ($('#logicConditions').find('.partType_'+ conditionCount +' :selected').val() == 'page'){
				$('#logicConditions').find('.qSelector'+'_' + conditionCount+'').hide();
				$('#logicConditions').find('.sSelector'+'_' + conditionCount+'').hide();
				$('#logicConditions').find('.pSelector'+'_' + conditionCount+'').show();
			}
	}

	function openForbiddenLogicDialog(){
		$('#forbiddenLogicDialog').dialog({
			autoOpen: false,
			height: 550,
			width: 700,
			modal: true,
			open: function(event, ui) {
				augmentDialogWithMaximizeButton($(this), 'forbiddenLogicDialog');
			},
			buttons: {
				'Close': function() {
					$(this).dialog('close');
				}
			},
			Cancel: function() {
				$(this).dialog('close');
			}
		});
		$('#forbiddenLogicDialog').dialog('open');
	}

	function openAddLogicDialog(questionId, questionLocalId) {
		
		$('#createQuestionLogicDialog').find('#activeLogic').val('');
		$('.bAddCondition').unbind('click');
		$('.bAddCondition').click(function() {addLogicCondition('OR', '', 'question', '', questionLocalId);});
		$('#createQuestionLogicDialog').dialog({
			autoOpen: false,
			height: 550,
			width: 700,
			modal: true,
			open: function(event, ui) {
				augmentDialogWithMaximizeButton($(this), 'createQuestionLogicDialog');
				ajax({
					url: ("{$BASEURL$}/questionnairelogicelement/retrieve?json=1&questionID=" + questionId),
					type: "GET",
					success: function(result) {
						conditionCounter = 0;
						var obj = jQuery.parseJSON(result);
						$('#logicConditions').html("");
						if (obj != null && obj.length > 0) {
							$('#logicConditions').append('<p style="font-size: 13px"><i>Currently Active Logic-Elements: </i></p>');
							for (var i = 0; i < obj.length; i++) {
								var le = obj[i];
								preLoadLogicCondition(le.operator, le.answers, le.typeOfPart, le.idOfPart, le.questionIdWithLogic);
							}
							$("#bottomAddCondition").show();
						}
					}
				});
			},
			buttons: {
				'Save New Logic': function() {
					var allAnswersFilled = true;
					var allTargetsFilled = true;
					$("#bottomAddCondition").hide();
					$('*[class*=answerList' + questionLocalId + '_]:visible').each(function(){
						if($(this).has('li').length == 0){allAnswersFilled = false;}
					});
					$('*[class*=targetIds' + questionLocalId + '_]:visible').each(function(){
						if($(this).has('li').length == 0){allTargetsFilled = false;}
					});
					if (allAnswersFilled && allTargetsFilled){
						ajax({
							url: ("{$BASEURL$}/survey/update?part=question&surveyID={SURVEYID}&createLogic=1&sourceQuestId=" + questionLocalId +"&logicConditionCounter=" + conditionCounter + "&questionID="+ questionId),
							type: "POST",
							data: $("#createQuestionLogicForm").serialize(),
							success: function(result) {
								if(result != ""){
									openForbiddenLogicDialog();
									$('#forbiddenLogicDialog').find('.logicErrMsg').html(result);
								} else {
									$('#createQuestionLogicDialog').dialog('close');
									location.reload();
									conditionCounter = 0;
								}
							}
						});
						$(this).dialog('close');
					} else if (!allAnswersFilled && allTargetsFilled){
						alert('An answer field is empty. Please select at least one answer for each logic condition.');
					} else if (allAnswersFilled && !allTargetsFilled){
						alert('A target-logic field is empty. Please select at least one target-part-id (either question, section or page) for each logic condition.');
					} else if (!allAnswersFilled && !allTargetsFilled){
						alert('Please add Options into the Answer List and Target-Ids (of Questions or Sections or Pages) into the Target-Id List!');
					}
				},
				'Cancel': function() {
					$("#bottomAddCondition").hide();
					$(this).dialog('close');
					$(this).dialog('destroy');
				}
			},
			Cancel: function() {
				$("#bottomAddCondition").hide();
				$(this).dialog('close');
				$(this).dialog('destroy');
			}
		});
		$('#createQuestionLogicDialog').dialog('open');
	}

	function makeOptionsSortable() {
		$("#optionList").sortable();
		/* $("#optionList").disableSelection();*/
		$("#subQuestionList").sortable();
		/* $("#subQuestionList").disableSelection();*/
	}

	function addPage(pageId) {
		$("#pages").append('<li><ul class="questionarePage content" id="page' + pageId + '"><li><input type="button" class="addSectionButton" id="asb' + pageId + '" name="addSectionButton' + pageId + '" value="Add Section" /></li></ul></li>');
		$("input:button").button();
	}

	function addSection(sectionId, pageId) {
		$('#page' + pageId).append('<li class="section" id="sectionItem' + sectionId + '"><ul class="questionareSection" id="section' + sectionId + '"><li><input type="button" class="addQuestionButton" id="aqb' + sectionId + '" name="addQuestionButton' + sectionId + '" value="Add Question" /></li></ul></li>');
		$(".questionarePage").sortable('refresh');
		$("input:button").button();
	}

	function addQuestion(questionId, sectionId) {
		$('#section' + sectionId).append('<li class="question" id="question' + questionId + '"><div id="questionContent_'+ questionId +'"></div></li>');
		$(".questionareSection").sortable('refresh');
		ajax({
			url: ("{$BASEURL$}/survey/retrieve?surveyID={SURVEYID}&part=question&questionID=" + questionId),
			type: "GET",
			success:
				function (result) {
					if (result != "") {
						var obj = jQuery.parseJSON(result);
						$("#questionContent_" + obj.id).html(obj.htmlRepresentation);
					}
				}
		});
	}

	function openEditSectionTitleDialog(sectionID) {
		
		$("#editSectionTitleDialog").dialog({
			autoOpen: false,
			height: 200,
			width: 650,
			modal: true,
			maximize: true,
			open: function(event, ui) {
				var currentTitle = $('#sectionTitle' + sectionID).text();
				$('#sectionTitle').val(currentTitle);
				augmentDialogWithMaximizeButton($(this), 'editSectionTitleDialog');
			},
			buttons: {
				'Ok': function() {
					ajax({
						url: ("{$BASEURL$}/survey/update?part=section&sectionID=" + sectionID),
						type: "GET",
						data: $("#editSectionTitleForm").serialize(),
						success:
							function (result) {
								$('#sectionTitle' + sectionID).html($('#sectionTitle').val());
								$('#editSectionTitleDialog').dialog('close');
								location.href= '#section' + sectionID;
								location.reload();
							}
					});
				},
				'Cancel': function() {
					$(this).dialog('close');
					$(this).dialog('destroy');
				}
			},
			Cancel: function() {
				$(this).dialog('close');
				$(this).dialog('destroy');
			}
		});
		$('#editSectionTitleDialog').dialog('open');
	}

	function insertQuestion(sectionID, position) {
		if (copyQuestionID > -1 || moveQuestionID > -1) {
			var operation = '';
			var id = -1;
			if (copyQuestionID > -1) {
				operation = 'copy';
				id = copyQuestionID;
			} else {
				operation = 'move';
				id = moveQuestionID;
			}

			ajax({
				url: ("{$BASEURL$}/survey/update?part=section&sectionID=" + sectionID + "&operation=" + operation + "&questionID=" + id + "&position=" + position),
				type: "GET",
				success:
					function (result) {
						location.href= '#section' + sectionID;
						location.reload();
					}
			});
		}
	}

	function insertSection(pageID, position) {
		if (copySectionID > -1 || moveSectionID > -1) {
			var operation = '';
			var id = -1;
			if (copySectionID > -1) {
				operation = 'copy';
				id = copySectionID;
			} else {
				operation = 'move';
				id = moveSectionID;
			}

			ajax({
				url: ("{$BASEURL$}/survey/update?part=page&pageID=" + pageID + "&operation=" + operation + "&sectionID=" + id + "&position=" + position),
				type: "GET",
				success:
					function (result) {
						location.href= '#page' + pageID;
						location.reload();
					}
			});
		}
	}

	function insertEmptyPage(insertAt, nextPage) {
		ajax({
			url: ("{$BASEURL$}/survey/create?part=page&surveyID={SURVEYID}&insertAt=" + insertAt),
			type: "GET",
			success:
				function (result) {
					if (result != "") {
						if (nextPage) {
							location.href='{NEXTPAGELINK}';
						} else {
							location.reload();
						}
					}
				}
		});
	}

	function insertPage(surveyID, position) {
		if (copyPageID > -1 || movePageID > -1) {
			var operation = '';
			var id = -1;
			if (copyPageID > -1) {
				operation = 'copy';
				id = copyPageID;
			} else {
				operation = 'move';
				id = movePageID;
			}

			ajax({
				url: ("{$BASEURL$}/survey/update?part=survey&surveyID=" + surveyID + "&operation=" + operation + "&pageID=" + id + "&position=" + position),
				type: "GET",
				success:
					function (result) {
						location.href= '#survey' + surveyID;
						location.reload();
					}
			});
		}
	}
/* ]]> */
</script>